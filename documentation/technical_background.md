# Technical background

## File directories

Files are stored in the following locations:
- This repository contains all Research Analyses, they are stored in the [Analyses](../analyses) folder.
- Old versions of the Research Analyses have been stored on `~/Dropbox/Quintel/Projects/Restructure Research Dataset/analysis/analyses`. Since September 25, 2013, we removed version numbers from Excel file names. Version controlling is now only done with Git.
- Source analyses are stored in the [Source Analyses](../source_analyses) folder. Old versions are stored on Dropbox.
- Original and CONFIDENTIAL IEA data tables are stored on Dropbox, in `~/Dropbox/Quintel/Projects/Restructure Research Dataset/Using IEA/IEA paid sources`.


<!-- Outdated:

The process outlined below will produce fresh CSV files from the Research Analyses (parent_shares, child_shares, time_curves, central_electricity_production and primary_production).

Currently, it is only possible to run the ETM with the base_year 2011.

* your fresh CSV files need to be copied to `~/Projects/etsource/data/datasets/<country>/...` and `~/PProjects/etsource/data/energy_balances'. Good practice: delete all old files before copying the new ones.
 * all parent and child share files go into the "shares" folder
 * all time curves go into the "time_curves" folder
 * all efficiencies go into the "efficiencies" folder
 * the central_electricity_production and primary_production files go directly into the nl/ folder.
 * you need to save the 'corrected_energy_balance_step_2' that was generated by the "2_power_and_heat_plant" analysis in `~/PProjects/etsource/data/energy_balances' (with the correct file name).

This process is automated by the rake task "rake import" or "rake import dataset=nl".

-->

## Using Git on both Binary and data files

Using Git presents its own unique challenges when binary (Excel) files are involved. The reason is that (without a little help) Git cannot see *what* changed between different versions of a binary file, only *that* something changed. In fact, pressing 'save' in Excel without having made any changes, leads to a changed file as far as Git is concerned. If two people change an Excel analysis and try to commit and push these changes, a merge conflict will result.


### How to `git diff` Excel files

Obtain `xlsx2text.py` from [here](../xlsx2text.py).

Place the `xlsx2text.py` in a location that is included in your $PATH, for example: **/usr/local/bin/**.

Make the script executable (use the path where you put the program):

    chmod +x xlsx2text.py


#### Setup for a repository

This method only impacts your local repository. We don't want to force
others to use the Python script. Go to the folder where you have your git project.

Add to **.git/info/attributes**:

    *.xlsx diff=xlsx

Create this file first, if it does not exist:

    cd .git/info/
    touch ./attributes

Add to **.git/config**:

    [diff "xlsx"]
        binary = true
        textconv = xlsx2text.py


#### Usage

You can use it as you normally use `git diff`, but the output is easier to read with syntax highlighting, so you might want to pipe the output to a
text editor that knows the diff file format.

Comparing commits a  and b:

    git diff -U0 <commit_a> <commit_b> | mate

The results for a `git diff` on an Excel file are separated in two sections. The formula version, starting with **Last modified at x, output with formula values**. And the calculated values, starting with **Last modified at x, output with calculated values**

Running `git diff` will take up to ten seconds per Excel file.

Add the argument `-U0` if you don't want to show any extra lines in the output beside the ones that changed


#### Extra info

- Custom git diff systems [Git page](http://git-scm.com/book/ch7-2.html).

- Based on [xlsx2csv](https://github.com/dilshod/xlsx2csv).

