graph TD
      A[broeikasgassen_doelgroep_<br/>subdoelgroep2023.xlsx<br/>Sheet: 2023] --> B[df_emissie_registratie<br/>Raw Emissions Data]

      B --> C{Filter by Categories}

      %% Main Industries
      C --> D1[Steel Industries<br/>SBI 24 processes]
      C --> D2[Aluminium Industries<br/>SBI 24.45 processes]
      C --> D3[Fertilizers<br/>Chemische Industrie kunstmeststoffen]
      C --> D4[Refineries<br/>Raffinaderijen]

      %% Other Industries
      C --> D5[Other Industry Sector<br/>Overige industrie]
      D5 --> D5a[Chemical Other<br/>basisproducten + bestrijdingsmiddelen + overig]
      D5 --> D5b[Food Industry<br/>Voedings- en genotmiddelenindustrie]
      D5 --> D5c[Paper Industry<br/>Papier waren]
      D5 --> D5d[Metal Other<br/>SBI 24.5 + Basismetaal]
      D5 --> D5e[Industry Other<br/>Residual calculation]

      %% Agriculture
      C --> D6[Agriculture Gas WKK<br/>Aardgasverbruik landbouw WKK]
      C --> D7[Agriculture Gas Non-WKK<br/>Aardgasverbruik landbouw niet WKK]

      %% Processing - Main Industries
      D1 --> E1[Clean & Aggregate<br/>Group by GEMEENTENAAM<br/>Sum EMISSIE_KG]
      D2 --> E2[Clean & Aggregate<br/>Group by GEMEENTENAAM<br/>Sum EMISSIE_KG]
      D3 --> E3[Clean & Aggregate<br/>Group by GEMEENTENAAM<br/>Sum EMISSIE_KG]
      D4 --> E4[Clean & Aggregate<br/>Group by GEMEENTENAAM<br/>Sum EMISSIE_KG]

      %% Processing - Other Industries
      D5a --> E5a[Aggregate Chemical Other]
      D5b --> E5b[Aggregate Food]
      D5c --> E5c[Aggregate Paper]
      D5d --> E5d[Aggregate Metal Other]
      D5e --> E5e[Calculate Industry Other<br/>Total - Food - Paper - Base metals]

      E5a --> F5a[Scale: chemical_other_co2_scaled]
      E5b --> F5b[Scale: food_co2_scaled]
      E5c --> F5c[Scale: paper_co2_scaled]
      E5d --> F5d[Scale: metal_other_co2_scaled]
      E5e --> F5e[Scale: industry_other_co2_scaled]

      %% Processing - Agriculture
      D6 --> E6[Aggregate Agriculture WKK]
      D7 --> E7[Aggregate Agriculture Non-WKK]
      E6 --> F6[Merge WKK + Non-WKK]
      E7 --> F6
      F6 --> F6a[Calculate Relative Shares<br/>agriculture_gas_chp_relative<br/>agriculture_gas_final_demand_relative]

      %% Scaling - Main Industries
      E1 --> F1[Scale: steel_co2_scaled]
      E2 --> F2[Scale: aluminium_co2_scaled]
      E3 --> F3[Scale: fertilizers_co2_scaled]
      E4 --> F4[Scale: refineries_co2_scaled]

      %% Final outputs
      F1 --> G1[df_steel_co2_scaled_final]
      F2 --> G2[df_aluminium_co2_scaled_final]
      F3 --> G3[df_fertilizers_co2_scaled_final]
      F4 --> G4[df_refineries_co2_scaled_final]

      F5a --> G5a[Other Industry Variables<br/>5 scaled variables]
      F5b --> G5a
      F5c --> G5a
      F5d --> G5a
      F5e --> G5a

      F6a --> G6[df_agriculture_combined_final<br/>2 relative variables]

      %% Final merge
      G1 --> H[Merge All Datasets<br/>Left join on GEMEENTECODE]
      G2 --> H
      G3 --> H
      G4 --> H
      G5a --> H
      G6 --> H

      H --> I[er_final_demand_data_combined<br/>344 municipalities<br/>All industry + agriculture keys]

      I --> J[Export to CSV<br/>ER_final_demand_data_combined.csv<br/>data/intermediate/]

      %% Styling
      classDef inputFile fill:#e1f5fe,stroke:#0288d1,stroke-width:2px
      classDef process fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
      classDef output fill:#e8f5e8,stroke:#388e3c,stroke-width:2px
      classDef intermediate fill:#fff3e0,stroke:#f57c00,stroke-width:2px
      classDef agriculture fill:#e0f2f1,stroke:#00695c,stroke-width:2px

      class A inputFile
      class B,C,E1,E2,E3,E4,E5a,E5b,E5c,E5d,E5e,E6,E7,F1,F2,F3,F4,F5a,F5b,F5c,F5d,F5e,F6,F6a,H process
      class D1,D2,D3,D4,D5,D5a,D5b,D5c,D5d,D5e,G1,G2,G3,G4,G5a,I intermediate
      class D6,D7,G6 agriculture
      class J output